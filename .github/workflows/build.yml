name: Lua Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check:
    runs-on: ubuntu-latest
    name: Check
    steps:
      - uses: actions/checkout@v4

      - name: Setup Lua
        uses: leafo/gh-actions-lua@v11
        with:
          luaVersion: '5.4'

      - name: Setup LuaRocks
        uses: leafo/gh-actions-luarocks@v5
        with:
          luarocksVersion: "3.12.2"

      - name: Install luacheck
        run: luarocks install luacheck

      - name: Install stylua
        uses: JohnnyMorganz/stylua-action@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          version: v2.1.0
          args: false # Will be run as part of `make check`

      - name: Check
        run: make check

  test:
    needs: check
    runs-on: ubuntu-latest
    continue-on-error: false
    strategy:
      fail-fast: true
      matrix:
        lua-version: ['5.1', '5.2', '5.3', '5.4', 'luajit-2.0', 'luajit-2.1']

    name: Lua ${{ matrix.lua-version }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Lua
        uses: leafo/gh-actions-lua@v11
        with:
          luaVersion: ${{ matrix.lua-version }}

      - name: Setup LuaRocks
        uses: leafo/gh-actions-luarocks@v5
        with:
          luarocksVersion: "3.12.2"

      - name: Install lua-opensssl
        run: luarocks install openssl

      - name: Setup tests
        run: |
          # Set the correct binary name based on the Lua version
          if [[ "${{ matrix.lua-version }}" == luajit* ]]; then
            LUA_BINARY=luajit
          else
            LUA_BINARY=lua
          fi

          echo "LUA_BINARY=$LUA_BINARY" >> "$GITHUB_ENV"
          ${LUA_BINARY} -v

          # Run test vectors in parallel
          echo "NOISE_VECTOR_WORKERS=$(nproc)" >> "$GITHUB_ENV"

          # Use full test vectors only for LuaJIT 2.1, sampled for others
          if [[ "${{ matrix.lua-version }}" == "luajit-2.1" ]]; then
            # Include slow tests for LuaJIT 2.1
            echo "INCLUDE_SLOW_TESTS=1" >> "$GITHUB_ENV"
            
            echo "Using full test vectors for ${{ matrix.lua-version }}"
            echo "NOISE_VECTORS_DIR=vectors_full" >> "$GITHUB_ENV"
          else
            echo "Using sampled test vectors for ${{ matrix.lua-version }}"
            echo "NOISE_VECTORS_DIR=vectors_sampled" >> "$GITHUB_ENV"
          fi

      - name: Run tests
        run: |
          make test-all

      - name: Run tests using OpenSSL
        run: |
          NOISE_USE_OPENSSL=1 make test-all

  build:
    needs: test
    runs-on: ubuntu-latest
    name: Build Combined Module
    steps:
      - uses: actions/checkout@v4

      - name: Setup Lua
        uses: leafo/gh-actions-lua@v11
        with:
          luaVersion: '5.4'

      - name: Setup LuaRocks
        uses: leafo/gh-actions-luarocks@v5
        with:
          luarocksVersion: "3.12.2"

      - name: Install amalg
        run: luarocks install amalg

      - name: Build combined module
        run: make build

      - name: Verify build
        run: |
          # Check default build
          if [ -f "build/noiseprotocol.lua" ]; then
            echo "✅ build/noiseprotocol.lua exists ($(wc -c < "build/noiseprotocol.lua") bytes)"
            # Quick sanity check - make sure it contains expected content
            if grep -q "Noise Protocol Framework" build/noiseprotocol.lua; then
              echo "✅ Build contains expected content"
            else
              echo "❌ Build seems corrupted"
              exit 1
            fi
          else
            echo "❌ build/noiseprotocol.lua missing"
            exit 1
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: noiseprotocol.lua
          path: build/noiseprotocol.lua
          retention-days: 30
